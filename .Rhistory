opq()
q1xml <-  osmdata_xml(q1, "data.xml")
test <- osmdata_sf(q1, q1xml)
lines <-  test$osm_lines
q1 <- getbb ("Denmark") %>%
opq("Denmark")
q1xml <-  osmdata_xml(q1, "data.xml")
test <- osmdata_sf(q1, q1xml)
lines <-  test$osm_lines
bboxdenmark <- getbb ("Denmark")
bboxdenmark <- getbb ("Denmark")
q1 <- opg(bboxdenmark) %>% add_osm_feature(key= value="!primary")
q1xml <-  osmdata_xml(q1, "data.xml")
q1sf <- osmdata_sf(q1, q1xml)
lines <-  q1sf$osm_lines
bboxdenmark <- getbb ("Denmark")
q1 <- opg(bboxdenmark) %>% add_osm_feature(key="highway" value = "!primary")
q1xml <-  osmdata_xml(q1, "data.xml")
q1sf <- osmdata_sf(q1, q1xml)
lines <-  q1sf$osm_lines
q1 <- opg(bboxdenmark) %>% add_osm_feature(key="highway", value = "!primary")
q1 <- opq(bboxdenmark) %>% add_osm_feature(key="highway", value = "!primary")
q1xml <-  osmdata_xml(q1, "data.xml")
q1sf <- osmdata_sf(q1, q1xml)
lines <-  q1sf$osm_lines
View(lines)
bboxdenmark <- getbb ("Denmark")
q1 <- opq(bboxdenmark) %>% add_osm_feature(key="is_in.counrty", value = "Denmark")
q1xml <-  osmdata_xml(q1, "data.xml")
q1sf <- osmdata_sf(q1, q1xml)
lines <-  q1sf$osm_lines
q1 <- opq(bboxdenmark) %>% add_osm_feature(key="is_in.country", value = "Denmark")
q1xml <-  osmdata_xml(q1, "data.xml")
q1sf <- osmdata_sf(q1, q1xml)
lines <-  q1sf$osm_lines
q1 <- opq(getbb("Denmark")) %>% add_osm_feature(key="is_in.country", value = "Denmark")
q1xml <-  osmdata_xml(q1, "data.xml")
q1sf <- osmdata_sf(q1, q1xml)
lines <-  q1sf$osm_lines
View(bboxdenmark)
View(bboxdenmark)
q1 <- opq(bbox =c(-63.17704, 45.65837, -63.11791, 45.71981)) %>% add_osm_feature(key="is_in.country", value = "Denmark")
q1xml <-  osmdata_xml(q1, "data.xml")
q1sf <- osmdata_sf(q1, q1xml)
lines <-  q1sf$osm_lines
q1 <- opq(bbox =c(-63.17704, 45.65837, -63.11791, 45.71981)) %>% add_osm_feature(key="name", value = "Denmark")
q1xml <-  osmdata_xml(q1, "data.xml")
q1sf <- osmdata_sf(q1, q1xml)
lines <-  q1sf$osm_lines
q1 <- opq(bbox= c(-0.27, 51.47, -0.20, 51.50)) %>% add_osm_feature(key = 'name', value = "Thames", value_exact = FALSE)
q1xml <-  osmdata_xml(q1, "data.xml")
test <- osmdata_sf(q1, q1xml)
lines <-  test$osm_lines
View(lines)
q1 <- opq(bbox= c(-0.27, 51.47, -0.20, 51.50)) %>% add_osm_feature(key="highway", value = "!primary", value_exact = FALSE)
bboxdenmark <- getbb ("Denmark")
q1 <- opq(bbox =c(-63.17, 45.65, -63.11, 45.71)) %>% add_osm_feature(key="highway", value = "!primary", value_exact = FALSE)
q1xml <-  osmdata_xml(q1, "data.xml")
q1sf <- osmdata_sf(q1, q1xml)
lines <-  q1sf$osm_lines
View(lines)
?getbb
bboxdenmark <- getbb ("danmark")
View(bboxdenmark)
View(bboxdenmark)
View(bboxdenmark)
View(bboxdenmark)
q1 <- opq(bbox =c(17.72417, 59.81229, 17.76417, 59.85229)) %>% add_osm_feature(key="name", value = "Denmark")
q1xml <-  osmdata_xml(q1, "data.xml")
q1sf <- osmdata_sf(q1, q1xml)
lines <-  q1sf$osm_lines
q1 <- opq(bbox =c(17.72417, 59.81229, 17.76417, 59.85229)) %>% add_osm_feature(key="highway", value = "!primary")
q1xml <-  osmdata_xml(q1, "data.xml")
q1sf <- osmdata_sf(q1, q1xml)
lines <-  q1sf$osm_lines
View(lines)
q1 <- opq(bbox =c(7.639531770008239 , 54.21240948951606, 15.860117597032367 , 58.19122284484052)) %>% add_osm_feature(key="highway", value = "!primary")
q1xml <-  osmdata_xml(q1, "data.xml")
q1sf <- osmdata_sf(q1, q1xml)
lines <-  q1sf$osm_lines
q1xml <-  osmdata_xml(q1, "data.xml")
View(q1)
q1 <- opq(bbox =c(7.639531770008239 , 54.21240948951606, 15.860117597032367 , 58.19122284484052)) %>% add_osm_feature(key="highway", value = "!primary")
q1 <- opq(bbox =c(7.63 , 54.21, 15.86 , 58.19)) %>% add_osm_feature(key="highway", value = "!primary")
q1xml <-  osmdata_xml(q1, "data.xml")
rm(lines, q,q1,q1sf,q1xml,test,x)
library("osmdata")
bboxdenmark <- getbb ("danmark")
View(bboxdenmark)
q1 <- opq(bbox = c(8.0043,54.5352,15.2223,57.7875)) %>% add_osm_feature(key="highway", value = "!primary")
q1xml <-  osmdata_xml(q1, "data.xml")
q1 <- opq(bbox = c(54.5352,8.0043,57.7875,15.2223)) %>% add_osm_feature(key="highway", value = "!primary")
q1xml <-  osmdata_xml(q1, "data.xml")
q1sf <- osmdata_sf(q1, q1xml)
lines <-  q1sf$osm_lines
View(lines)
?bbox
View(bboxdenmark)
bbox1 <- c(8.0043,54.5352,15.2223,57.7875)
View(bboxdenmark)
xy= cbind(x,y)
x =   c(8.0043,15.2223)
y =   c(54.5352,57.7875)
xy= cbind(x,y)
View(xy)
S <-  SpatialPoints(xy)
??SpatialPoints
S <-  sp::SpatialPoints(xy)
q1 <- opq(bbox = S) %>% add_osm_feature(key="highway", value = "!primary")
q1 <- opq(bbox = bbox(S)) %>% add_osm_feature(key="highway", value = "!primary")
library("osmdata")
q1 <- opq(bbox = bbox(S)) %>% add_osm_feature(key="highway", value = "!primary")
q1 <- opq(bbox = sp::bbox(S)) %>% add_osm_feature(key="highway", value = "!primary")
q1xml <-  osmdata_xml(q1, "data.xml")
box <- sp::bbox(S)
View(box)
View(bboxdenmark)
q1 <- opq(bbox = sp::bbox(S)) %>% add_osm_feature(key="highway", value = "residential")
q1xml <-  osmdata_xml(q1, "data.xml")
q1 <- opq(bbox = sp::bbox(S)) %>% add_osm_feature(key="highway", value = "residential")
q1sf <- osmdata_sf(q1)
x =   c(8.0043,15.2223)       # longitude
y =   c(54.5352,57.7875)      # Latitude
xy = cbind(x,y)  # bind to matrix
View(box)
View(bboxdenmark)
library("osmdata")
#---------------------------------------------------------------------------
#manually create bbox for Denmark
x =   c(8.0043,15.2223)       # longitude
y =   c(54.5352,57.7875)      # Latitude
xy = cbind(x,y)  # bind to matrix
S <-  sp::SpatialPoints(xy) #create spatial points
box <- sp::bbox(S) #Creates bbox of spatial points
q1 <- opq(bbox = sp::bbox(S)) %>% add_osm_feature(key="highway", value = "residential")
q1xml <-  osmdata_xml(q1, "data.xml")
q1sf <- osmdata_sf(q1)
Roskilde <-  getbb("Roskilde")
View(Roskilde)
bboxdenmark <- getbb ("danmark") # seems worng and return data from canada
library("rvest")
library("magritter")
library("magrittr")
search.link <- "https://www.airbnb.dk/s/Danmark/homes?refinement_paths%5B%5D=%2Fhomes&allow_override%5B%5D"
respond <-  search.link %>%
read_html()
respond <-  search.link %>%
read_html() %>%
html_nodes("_1df8dftk")
View(respond)
search.link %>%
read_html()
respond <-  search.link %>%
read_html() %>%
html_nodes("._ng4pvpo")
respond <-  search.link %>%
read_html() %>%
html_node("._ng4pvpo")
search.link <- "https://www.airbnb.dk/s/Danmark/homes?refinement_paths%5B%5D=%2Fhomes&allow_override%5B%5D"
search.link %>%
read_html()
search.link <- "https://www.airbnb.dk/s/Danmark/homes?"
respond <-  search.link %>%
read_html()
View(respond)
View(respond)
respond <- respond$node
respond <-  search.link %>%
read_html()
respond <- respond$doc
respond <-  search.link %>%
read_html()
respond <-  search.link %>%
read_html() %>%
html_node("._ng4pvpo") %>%
html_text()
respond <-  search.link %>%
read_html() %>%
html_node("._ng4pvpo")
respond <-  search.link %>%
read_html() %>%
html_nodes("._ng4pvpo") %>%
html_text()
respond <-  search.link %>%
read_html()
View(respond)
View(respond)
respond <-  search.link %>%
read_html() %>%
html_nodes("//*[contains(concat( " ", @class, " " ), concat( " ", "_1df8dftk", " " ))]")
respond <-  search.link %>%
read_html() %>%
html_nodes(//*[contains(concat( " ", @class, " " ), concat( " ", "_1df8dftk", " " ))])
xpath = "//*[contains(concat( " ", @class, " " ), concat( " ", "_1df8dftk", " " ))]"
respond <-  search.link %>%
read_html() %>%
html_nodes("//*[contains(concat( " ", @class, " " ), concat( " ", "_1df8dftk", " " ))]")
respond <-  search.link %>%
read_html() %>%
html_nodes("_1df8dftk")
css.link    = "._1df8dftk"
respond <-  search.link %>%
read_html() %>%
html_nodes(css.link)
respond <-  search.link %>%
read_html() %>%
html_nodes(xpath)
xpath = "//*[contains(concat( " ", @class, " " ), concat( " ", "_1df8dftk", " " ))]"
xpath ="//*[contains(concat(" ", @class, " " ), concat( " ", "_1df8dftk", " "))]"
xpath ="//*[contains(concat(' ', @class, ' ' ), concat( ' ', '_1df8dftk', ' '))]"
respond <-  search.link %>%
read_html() %>%
html_nodes(xpath)
xpath =//*[contains(concat(' ', @class, ' ' ), concat( ' ', '_1df8dftk', ' '))]
xpath = //*[contains(concat(' ', @class, ' ' ), concat( ' ', '_1df8dftk', ' '))]
xpath = "//*[contains(concat(' ', @class, ' ' ), concat( ' ', '_1df8dftk', ' '))]"
respond <-  search.link %>%
read_html() %>%
html_nodes(xpath)
we = driver.findElement(By.cssSelector("._1df8dftk"))
install.packages("seleniumPipes")
library("seleniumPipes")
we = driver.findElement(By.cssSelector("._1df8dftk"))
xpath = "//*[]/div[2]/a/div[2]/div/div"
respond <-  search.link %>%
read_html() %>%
html_nodes(xpath)
xpath = "div[2]/a/div[2]/div/div"
respond <-  search.link %>%
read_html() %>%
html_nodes(xpath)
respond <-  search.link %>%
read_html() %>%
html_nodes(href)
respond <-  search.link %>%
read_html() %>%
html_nodes("href")
respond <-  search.link %>%
read_html() %>%
html_nodes("a")
View(respond)
respond <-  search.link %>%
read_html() %>%
html_nodes("div")
View(respond)
respond <-  search.link %>%
read_html() %>%
html_nodes("class=_1df8dftk")
respond <-  search.link %>%
read_html() %>%
html_nodes("a")
View(respond)
respond <-  search.link %>%
read_html() %>%
html_nodes("div._1df8dftk")
respond <-  search.link %>%
read_html() %>%
html_nodes("div.1df8dftk")
respond <-  search.link %>%
read_html() %>%
html_nodes("div._1df8dftk")
?html_nodes
search.link %>%
read_html()
respond <-  search.link %>%
read_html()
respond <-  search.link %>%
read_html() %>%
html_nodes("a")
View(respond)
respond <- respond$body
respond <-  search.link %>%
read_html() %>%
html_nodes("a") %>%
html_text()
respond
respond <-  search.link %>%
read_html() %>%
html_nodes("._1df8dftk") %>%
html_text()
respond <-  search.link %>%
read_html() %>%
html_nodes("_1df8dftk") %>%
html_text()
respond <-  search.link %>%
read_html() %>%
html_nodes(//*[contains(concat( " ", @class, " " ), concat( " ", "_ng4pvpo", " " ))]) %>%
html_text()
respond <-  search.link %>%
read_html() %>%
html_nodes("._ng4pvpo") %>%
html_text()
respond <-  search.link %>%
read_html() %>%
html_nodes(xpath) %>%
html_text()
xpath = "div[2]/a/div[2]/div/div"
respond <-  search.link %>%
read_html() %>%
html_nodes(xpath) %>%
html_text()
respond <-  search.link %>%
read_html() %>%
html_nodes("div") %>%
html_text()
respond
search.link <- "https://www.airbnb.dk/s/Danmark/homes?refinement_paths%5B%5D=%2Fhomes&allow_override%5B%5D"
respond <-  search.link %>%
read_html() %>%
html_nodes("div") %>%
html_text()
respond
._ng4pvpo
respond <-  search.link %>%
read_html() %>%
html_nodes("a") %>%
html_text()
respond
respond <-  search.link %>%
read_html() %>%
html_nodes("._1df8dftk") %>%
html_text()
respond <-  search.link %>%
read_html() %>%
html_nodes("_1df8dftk") %>%
html_text()
================================
# scrape.R
# --------------------------------
# Author: KahoIshii
# Created: Jan '17
# **** see README.md ****
# ================================
rm(list = ls()) ; set.seed(7)
# ----------- Libaries
library(rvest)
library(stringr)
library(dplyr)
library(readr)
library(lubridate)
library(tidyr)
library(data.table)
# library(logging)
base.path <- "C:/Users/ftp/OneDrive - Erhvervsstyrelsen/Github/AirBnB_scraber"
setwd(base.path)
today <- str_replace_all(substr(today(),6,10),"-","")
url.page1 <- "https://www.airbnb.dk/s/Danmark/homes?refinement_paths%5B%5D=%2Fhomes&allow_override%5B%5D=&s_tag=fD8vk32v"
pages.max <- 17
url.pages <- url.page1
url.diff <- "&section_offset="
for(page.num in 2:pages.max){
tmp <- paste0(url.page1,url.diff,page.num-1)
url.pages <- append(url.pages,tmp)
}
pages.max <- 17
url.pages <- url.pages[1:17]
content.per.page <- 18
for (page.num in 1:pages.max){
content <- read_html(url.pages[page.num])
# content <- read_html(url.page1)
needed <- content %>%
html_nodes(css = "._15ns6vh")
tmp <- content %>%
html_nodes(css="div a ._1yarz4r ._36rlri") %>%
.[seq(3,54,3)]
result.info5 <- data.frame(TEMP=rep(NA,content.per.page)) %>%
mutate(INFO5=ifelse(str_detect(as.character(tmp),'<div class="_36rlri">\n<span class="_1uyixqdu"'),
as.character(html_nodes(tmp,css="._1uyixqdu")),
NA)) %>%
mutate(INFO5=ifelse(!is.na(INFO5),str_split_fixed(INFO5,"評価：",2)[,2],NA)) %>%
mutate(INFO5=ifelse(!is.na(INFO5),str_split_fixed(INFO5,"／5",2)[,1],NA)) %>%
mutate(INFO5=as.numeric(INFO5))
result.temp <- content %>%
html_nodes(css = "._1szwzht a") %>%
html_attr("href") %>%
as.data.frame %>%
rename_("ORIGINAL"=".") %>%
mutate(FULL.DATA=!is.na(result.info5$INFO5)) %>%
mutate(INFO1=html_text(html_nodes(needed,css="._saba1yg"))) %>%
mutate(INFO2=html_text(html_nodes(needed,css="._1rths372"))) %>%
mutate(INFO3=html_text(html_nodes(needed,css="._ncmdki"))) %>%
mutate(INFO4=ifelse(!is.na(FULL.DATA),
html_text(html_nodes(needed,css="._36rlri ._gb7fydm")),
NA)) %>%
mutate(INFO5=result.info5$INFO5) %>%
mutate(TYPE=str_split_fixed(INFO1," · ",2)[,1]) %>%
mutate(BED=str_split_fixed(INFO1," · ",2)[,2]) %>%
mutate(BED=str_replace_all(BED,"ベッド","")) %>%
mutate(BED=str_replace_all(BED,"台","")) %>%
mutate(DESC=as.character(INFO2)) %>%
mutate(PRICE=str_replace_all(INFO3,"料金¥ ","")) %>%
mutate(PRICE=str_replace_all(PRICE,"～/泊","")) %>%
mutate(PRICE=as.numeric(str_replace_all(PRICE,",",""))) %>%
mutate(REVIEW=str_replace_all(INFO5,"レビュー","")) %>%
mutate(REVIEW=str_replace_all(REVIEW,"件","")) %>%
mutate(REVIEW=as.numeric(REVIEW)) %>%
mutate(PAGE=url.pages[page.num])
if(page.num==1){
result.df <- result.temp
} else {
result.df <- rbind(result.df,result.temp)
}
Sys.sleep(0.5)
}
for (page.num in 1:pages.max){
content <- read_html(url.pages[page.num])
# content <- read_html(url.page1)
needed <- content %>%
html_nodes(css = "._15ns6vh")
tmp <- content %>%
html_nodes(css="div a ._1yarz4r ._36rlri") %>%
.[seq(3,54,3)]
result.info5 <- data.frame(TEMP=rep(NA,content.per.page)) %>%
mutate(INFO5=ifelse(str_detect(as.character(tmp),'<div class="_36rlri">\n<span class="_1uyixqdu"'),
as.character(html_nodes(tmp,css="._1uyixqdu")),
NA)) %>%
mutate(INFO5=ifelse(!is.na(INFO5),str_split_fixed(INFO5,"評価：",2)[,2],NA)) %>%
mutate(INFO5=ifelse(!is.na(INFO5),str_split_fixed(INFO5,"／5",2)[,1],NA)) %>%
mutate(INFO5=as.numeric(INFO5))
result.temp <- content %>%
html_nodes(css = "._1szwzht a") %>%
html_attr("href") %>%
as.data.frame %>%
rename_("ORIGINAL"=".") %>%
mutate(FULL.DATA=!is.na(result.info5$INFO5)) %>%
mutate(INFO1=html_text(html_nodes(needed,css="._saba1yg"))) %>%
mutate(INFO2=html_text(html_nodes(needed,css="._1rths372"))) %>%
mutate(INFO3=html_text(html_nodes(needed,css="._ncmdki"))) %>%
mutate(INFO4=ifelse(!is.na(FULL.DATA),
html_text(html_nodes(needed,css="._36rlri ._gb7fydm")),
NA)) %>%
mutate(INFO5=result.info5$INFO5) %>%
mutate(TYPE=str_split_fixed(INFO1," · ",2)[,1]) %>%
mutate(BED=str_split_fixed(INFO1," · ",2)[,2]) %>%
mutate(BED=str_replace_all(BED,"ベッド","")) %>%
mutate(BED=str_replace_all(BED,"台","")) %>%
mutate(DESC=as.character(INFO2)) %>%
mutate(PRICE=str_replace_all(INFO3,"料金¥ ","")) %>%
mutate(PRICE=str_replace_all(PRICE,"～/泊","")) %>%
mutate(PRICE=as.numeric(str_replace_all(PRICE,",",""))) %>%
mutate(REVIEW=str_replace_all(INFO5,"レビュー","")) %>%
mutate(REVIEW=str_replace_all(REVIEW,"件","")) %>%
mutate(REVIEW=as.numeric(REVIEW)) %>%
mutate(PAGE=url.pages[page.num])
if(page.num==1){
result.df <- result.temp
} else {
result.df <- rbind(result.df,result.temp)
}
Sys.sleep(0.5)
}
for (page.num in 1:pages.max){
content <- read_html(url.pages[page.num])
# content <- read_html(url.page1)
needed <- content %>%
html_nodes(css = "._15ns6vh")
tmp <- content %>%
html_nodes(css="div a ._1yarz4r ._36rlri") %>%
.[seq(3,54,3)]
result.info5 <- data.frame(TEMP=rep(NA,content.per.page)) %>%
mutate(INFO5=ifelse(str_detect(as.character(tmp),'<div class="_36rlri">\n<span class="_1uyixqdu"'),
as.character(html_nodes(tmp,css="._1uyixqdu")),
NA)) %>%
mutate(INFO5=ifelse(!is.na(INFO5),str_split_fixed(INFO5,"評価：",2)[,2],NA)) %>%
mutate(INFO5=ifelse(!is.na(INFO5),str_split_fixed(INFO5,"／5",2)[,1],NA)) %>%
mutate(INFO5=as.numeric(INFO5))
if(page.num==1){
result.df <- content
} else {
result.df <- rbind(result.df,content)
}
Sys.sleep(0.5)
}
for (page.num in 1:pages.max){
content <- read_html(url.pages[page.num])
# content <- read_html(url.page1)
needed <- content %>%
html_nodes(css = "._15ns6vh")
tmp <- content %>%
html_nodes(css="div a ._1yarz4r ._36rlri") %>%
.[seq(3,54,3)]
if(page.num==1){
result.df <- content
} else {
result.df <- rbind(result.df,content)
}
Sys.sleep(0.5)
}
View(result.df)
respond <-  search.link %>%
read_html() %>%
html_nodes(css= "_1df8dftk") %>%
html_text()
search.link <- "https://www.airbnb.dk/s/Danmark/homes?refinement_paths%5B%5D=%2Fhomes&allow_override%5B%5D"
xpath = "//*[contains(concat(' ', @class, ' ' ), concat( ' ', '_1df8dftk', ' '))]"
xpath = "div[2]/a/div[2]/div/div"
xpath    = "._1df8dftk"
._ng4pvpo
respond <-  search.link %>%
read_html() %>%
html_nodes(css= "_1df8dftk") %>%
html_text()
respond <-  search.link %>%
read_html() %>%
html_nodes(css= "._15ns6vh")
respond <-  search.link %>%
read_html() %>%
html_nodes(css= "div a ._1yarz4r ._36rlri") %>%
html_text()
respond <-  search.link %>%
read_html() %>%
html_nodes(css= "div a ._1yarz4r ._36rlri")
